:icons: font 
:sectanchors:
:sectnums:
:toc: 

:openshift_cluster_console: {openshift_cluster_console}
:user_name: %user_name%
:user_password: %openshift%
:devspaces_dashboard: %devspaces_dashboard%
:globex_user_password: %globex_user_password%
:openshift_subdomain: %openshift_subdomain%
:3scale_tenant: %3scale_tenant%
:globex_developer_portal: %globex_developer_portal%
:sso_tenant_console: %sso_tenant_console%
:sso_tenant_issuer_url: %sso_tenant_issuer_url%
:service_registry_url: %service_registry_url%
:api_designer_url: %api_designer_url%



//:openshift_cluster_console: https://console-openshift-console.apps.cluster-4j7tv.4j7tv.sandbox262.opentlc.com
//:user_name: user2
//:user_password: openshift
//:devspaces_dashboard: https://devspaces.apps.cluster-4j7tv.4j7tv.sandbox262.opentlc.com
//:globex_user_password: openshift
//:openshift_subdomain: apps.cluster-4j7tv.4j7tv.sandbox262.opentlc.com
//:3scale_tenant: https://3scale-user2-admin.apps.cluster-4j7tv.4j7tv.sandbox262.opentlc.com
//:globex_developer_portal: https://3scale-user2.apps.cluster-4j7tv.4j7tv.sandbox262.opentlc.com
//:sso_tenant_console: https://sso.apps.cluster-4j7tv.4j7tv.sandbox262.opentlc.com/auth/admin/globex-user2/console
//:sso_tenant_issuer_url: https://sso.apps.cluster-4j7tv.4j7tv.sandbox262.opentlc.com/auth/realms/globex-user2
//:service_registry_url: https://service-registry-user2.apps.cluster-4j7tv.4j7tv.sandbox262.opentlc.com
//:api_designer_url: https://apicurio-designer.apps.cluster-4j7tv.4j7tv.sandbox262.opentlc.com
  



== Deploy the Contract First Module

TODO: deploy the solution through BackStage


== Objectives

We will be covering a lot of ground in this module. There are two disttint sections in this module

* Setting up Mobile App: Red Hat SSO' OpenID Connects provides user SSO logins and also secure access to backend sytems. 
* Setting up Partner Portal Access: Users are managed by partners themselves, and Red Hat SSO' OpenID Connects only secures access to backend sytems. 

 Before you delve in, here is an outline of the activities.

* Configure *Red Hat SSO* for OpenID Configurations
* *Design an API* using Red Hat API Designer
** Import a template for *Globex Mobile OpenAPI* and *Partner Portals OpenAPI*
** Edit the Security Scheme of the template to include OpenID Connect (TBC need URL from Red Hat SSO)
* Manage specs in *Service Registry* 
** Manage application schema - in this case the OpenAPI Specifications - as a single source of truth
** Turn on Content vaidations
** Explore how OpenAPI can be used by the ecosytem
* Secure and managed APIs with *3scale API Management*
** Create Client account for Client ID management on Red Hat SSO
** Create 3scale Backend, Product and ActiveDoc
* Setup Mobile Gateway and Mobile App
* Setup Partner Gateway and Partner App

== Setup your Devspaces 
You are going to use OpenShift Dev Spaces for a number of activities. OpenShift Dev Spaces uses Kubernetes and containers to provide a consistent, secure, and zero-configuration development environment, accessible from a browser window.

=== Section Goals
* Launch OpenShift Dev Spaces
* Login as *{user_name}*
* Ensure you are logged in to OpenShift as well as *{user_name}*

=== Instructions
* In a browser window, navigate to the browser tab pointing to the Developer perspective of the OpenShift cluster. If you don't have a browser tab open on the console, click on {openshift_cluster_console}[OpenShift Console^, window=_console] to launch the console. If needed login with your username and password ({user_name}/{user_password}).

* On the top menu of the console, click on the image::images/openshift-application-menu.png[] icon, and in the drop-down box, select *Red Hat OpenShift Dev Spaces*.
+
.Access Red Hat Devspace
image::images/openshift-application-menu-2.png[]

* Login in with your OpenShift credentials ({user_name}/{user_password}). If this is the first time you access Dev Spaces, you have to authorize Dev Spaces to access your account. In the _Authorize Access_ window click on *Allow selected permissions*. 
+
.Red Hat Devspace - Allow selected permissions
image::images/devspace-auth-access.png[width=70%]

* You are directed to the Dev Spaces overview page, which shows the workspaces you have access to. You should see a single workspace, called *cloud-architecture-workshop*. The workspace needs a couple of seconds to start up.
+
.Red Hat Devspace - cloud-architecture-workshop
image::images/devspaces-workspace-starting.png[]

* Click on the *Open* link of the workspace.
+
.Red Hat Devspace - Open cloud-architecture-workshop
image::images/devspaces-workspace-started-1.png[]

* This opens the workspace, which will look pretty familiar if you are used to work with VS Code. Before opening the workspace, a pop-up might appear asking if you trust the contents of the workspace. Click *Yes, I trust the authors* to continue.
+
.Red Hat Devspace - Agree to trust the authors
image::images/devspaces-trust-contents.png[]

* The workspace contains all the resources you are going to use during the workshop. In the project explorer on the left of the workspace, open the *workshop/module-apim* folder as shown in the screenshot below
+
.Red Hat Devspace - API Module
image::images/apim/apim-devspaces.png[] 

* You can deploy various resources needed in this workshop to the OpenShift cluster directly from Dev Spaces. To do so, you will need access to the built-in *Terminal*. Click on the image::images/devspaces-menu.png[] icon on the top of the left menu, and select *Terminal -> New Terminal* from the drop-down menu.
+
.Red Hat Devspace - New terminal
image::images/apim/apim-devspaces-menu-new-terminal.png[]

* This opens a terminal in the bottom half of the workspace.
+
.Red Hat Devspace - Open terminal
image::images/apim/apim-devspaces-menu-terminal.png[]

* The OpenShift Dev Spaces environment has access to a plethora of command line tools, including *oc*, the OpenShift command line interface. Through OpenShift Dev Spaces you are automatically logged in into the OpenShift cluster. You can verify this with the command *oc whoami*.
+

[source,bash,role=copy, subs="attributes"]
----
oc whoami
----
+

.Output
[source, subs="attributes"]
----
{user_name}
----
+
[IMPORTANT]
====
If the the output of the `oc whoami` command does not correspond to your username ({user_name}), you need to logout and login again with the correct username.

[source, bash, role=copy, subs="attributes"]
----
oc logout
oc login -u {user_name} -p {user_password} 
----

====

* You will be working in the `globex-apim-{user_name}` namespace. So run this following command to start using that particular project

+
[source,bash,role=copy, subs="attributes"]
----
oc project globex-apim-{user_name}
----


+
.Red Hat Devspace - Verify that you are using the APIM namespace
image::images/apim/apim-terminal-setup.png[width=70%]

* Keep this browser tab open because you will referring to draft content, scripts and YAML files for creating objects on OpenShift

=== Scratchpad
As you work through this Contract First APIs module, there are a few variables and URLs that are needed throughout this activity. To make things easier and manageable we've setup a scratchpad within Devspaces. You can fill this scrachpad up with information needed as you are guided below so that you can progress through this activity faster.

{empty} +

== Red Hat SSO - An Introduction

Red Hat SSO is used in this module to both offer single-sign on to Mobile users, and also for securing the APIs. 

[TIP]
====
We will be using OpenID Connect which is an open authentication protocol that works on top of the OAuth 2.0 framework. OIDC  offers a discovery mechanism called *OpenID Connect Discovery*, where an OpenID server (here Red Hat SSO based on Keycloak) publishes its metadata at a well-known URL. This URL is typically a collection of various endpoints the server offers, some of which are used in this workshop too.    
====

* Launch Red Hat SSO from {sso_tenant_console}[SSO Console^,window="sso"] and login using username and password ({user_name}/{user_password}).
* Click on the *OpenID Endpoint Configuration* link to view the *OpenID Provider Configuration* of Red Hat SSO.
+
.Red Hat SSO - Logged In
image::images/apim/apim-sso-login.png[]
* Here is how the *OpenID Provider Configuration* looks like
+
.Red Hat SSO - OpenID Provider Configuration
image::images/apim/well-know-openid-configuration.png[]
* We are interested specifically in the following enpoints

[cols="50%,50%"]
|===
|Endpoint | URL

| *OpenID Provider Configuration (wellknown config)*: +
This URL provides a mechanism to discover the End-User's OpenID Provider and obtain information needed to interact with it, including OpenID/OAuth endpoint locations. The following endpoints is fetched from this URL |
\https://sso.{openshift_subdomain}/auth/realms/globex-{user_name}/.well-known/openid-configuration 

| *issuer*: +
This value is needed when we need to authorise a user through single sign-on |

\https://sso.{openshift_subdomain}/auth/realms/globex-{user_name} 

| *token_endpoint* : +
clients can obtain access tokens from the server using this token endpoint and use these same tokens to access protected resources (APIs in our case) |
\https://sso.{openshift_subdomain}/auth/realms/globex-{user_name}/protocol/openid-connect/token

|===

{empty} +

== Design and Manage Mobile OpenAPI Specification

API design refers to the process of developing application programming interfaces (APIs) that expose data and application functionality for use by developers and users. Red Hat API Designer, based on Apicurio, is a lightweight tool that helps you to design APIs. The API Designer sessions are stateless and you must save your API definition as a JSON file at the end of each session. 

In this step you will import the draft OpenAPI specs for *Mobile App* and *Partner Portal* and edit them to include *Security Schemes*. Once the API design phase is complete you will then manage that within Red Hat Service Registry.


=== Section Goals

* Import a draft OpenAPI spesification for Mobile App into an API Designer
* Edit the draft OpenAPI spesification to add *OpenID Security Schemes* and include Red Hat SSO's OpenID Provider Configuration
* Manage the Mobile OpenAPI with a Service Registry

=== Design Mobile OpenAPI
To import the OpenAPI draft into API designer, you can import as text OR upload as file. To keep things simple in this workshop, you will import the content by simply pasting the draft spec as YAML based text into the API designer.

[NOTE]
====
In a real-world scenario you would do the inverse: start with an empty API specification, and define the different elements of the spec document. You would then export the spec in JSON or YAML format (by copying the contents from the source editor) to your local file system and push it to version control.
====


* Launch API Designer by clicking on this link {api_designer_url}[API Designer^, window=api_designer]
* Click on the *New API* button.
+
.Red Hat API Designer - New API
image::images/apim/api-designer.png[] 
* Click on the *Source Tab* on the *New API* page, and delete the entire content in the window. 
** Note: Keep this tab open. You will be pasting the draft OpenAPI into this window.
+
.API Designer - Open Source Tab
image::images/apim/api-new-api.png[]
+
.API Designer: Clear all content in Source Tab
image::images/apim/api-desginer-clear.png[]

* To get the Mobile OpenAPI draft, navigate to the browser tab with *Dev Spaces* that you have earlier opened. 
** If you don't have a browser tab open on to Dev Spaces, click on {devspaces_dashboard}/dashboard/#/ide/devspaces-{user_name}/cloud-architecture-workshop[Devspaces IDE^, window="devspaces"]. If needed login with your username and password ({user_name}/{user_password}).
* In Devspaces, navigate to the folder `workshop -> module-apim -> mobile -> activedoc`, and open the file `mobile-activedoc-draft.yaml`
* Copy the content from this file `(Ctrl+A and Ctrl+C)` 
+
.Copy Mobile OpenAPI draft from Dev spaces
image::images/apim/mobile-draft-spec-devspace.png[]
* Now paste the copied (draft OpenAPI) from the above step into the API designer's *Source Tab*, and click on *Save* button as highlighted in the screenshot below.
+
.API Designer: Paste Mobile Draft OpenAPI
image::images/apim/mobile-draft-imported.png[]
* Navigate back to the *Design Tab*
+
.API Designer: Design Tab
image::images/apim/api-design-tab.png[]
* You will now need to update the security scheme. Under the *SECURITY SCHEMES* section, click on *Add a security scheme* link
+
.API Designer: Add a security scheme
image::images/apim/api-designer-sec-scheme.png[]
* You are presented with the *Define the Security Scheme* page. Provide the following values in the form, and click on *Save*

[cols="30%,70%"]
|====
| *Name* (textbox)| `openid-connect`
| *Description* (textarea) | `OpenID Connect security scheme`
| *Security Type* dropdown| `OpenID Connect`
| *OpenID Connect URL* (textbox) | `\https://sso.{openshift_subdomain}/auth/realms/globex-{user_name}/.well-known/openid-configuration`
|====
.API Designer: Define the Security Scheme wizard
image::images/apim/define-security-scheme.png[]


* You are navigated back to the homepage. Verify that you can see the *SECURITY SCHEMES* has been updated with your configuration
+
.API Designer: Verify openid-connect Security Scheme added
image::images/apim/security-scheme-complete.png[]
* The OpenAPI specificaion is now ready to be downloaded. Click on the _down arrow_ button adjacent to *Save As..* and the choose *Save as YAML* button found on top-right of the page. Save the file as `mobile-openapi-spec` in a place you can easily access (e.g. the Desktop).
** Don't close this broswer tab. You will use the Mobile OpenAPI YAML content from the API Designer in the next step.
+
.API Designer: Save API as YAML in your computer
image::images/apim/api-download-as-yaml.png[]

* The Mobile OpenAPI spec is ready to be governed with a Service Registry.

{empty} +

=== Manage the Mobile OpenAPI with Service Registry

* Launch *Service Registry* by accessing {service_registry_url}[Service Registry^, window="service_registry_url"]
+
.Service Registry: Landing Page
image::images/apim/service-registry-landing.png[]
* Click on the *Upload artifact* button as show in the above screenshot. You will be presented with a *Upload Artifact* wizard 
+
.Service Registry: *Upload Artifact* wizard 
image::images/apim/sr-upload-artifact.png[]

* In the wizard, enter the following details, and click on the *Upload* button

[cols="20%,50%"]
|====
| *Group* | `globex`
| *ID of the artifact* | `mobileapi`
| *Artifact textarea* | Copy `(Ctrl+A and Ctrl+C)` the YAML content of the Mobile OpenAPI specification from the API Designer, and Paste `(Ctrl+C)` into this textarea. +
Optionally, you can `drag & drop` (or) `upload` the YAML file with the Mobile OpenAPI you had downloaded in the previous step.

|====

.Service Registry: Provide information needed by *Upload Artifact* wizard  and *Upload*
image::images/apim/sr-spec-setting.png[]

* Note that the *Globex Mobile API Gateway* artifact has been uploaded and stored within *Service Registry*
+
.Service Registry: *Globex Mobile API Gateway* artifact has been uploaded
image::images/apim/sr-uploaded.png[]

* You can share this OpenAPI schema with others via this link 


[NOTE]
[subs="attributes"]
====
Note if you have provided different values for Group and ID in the previous steps, the URL will vary accordingly.
====


.Service Registry - Mobile API Schema endpoint
[source,bash,role=copy, subs="attributes"]
----
{service_registry_url}/apis/registry/v2/groups/globex/artifacts/mobileapi
----

{empty} +


[TIP]
====
This schema can be used for generating Quarkus code for both Clients and Serverside using maven plugins. (Note that the client is NodeJS+Angular in this this module)

* The serverside code for the https://github.com/rh-cloud-architecture-workshop/globex-mobile-gateway/blob/main/src/main/java/org/globex/gateway/mobile/rest/MobileCatalogResource.java[Mobile Gateway^, window="code-samples"] has been built using the https://mvnrepository.com/artifact/io.apicurio/apicurio-codegen-quarkus-extension[Apicurio Codegen Quarkus Extension, window="code-samples"]
* You can use https://github.com/quarkiverse/quarkus-openapi-generator[Quarkus extension from Quarkiverse^, window="code-samples"] to generate of Rest Clients based on OpenAPI specification files.

====

=== Section Outcome

* Edited the draft of Mobile OpenAPI using API Designer 
* Added Security Scheme to it with Red Hat SSOs OpenID configuration
* Imported the Mobile OpenAPI into Service Registry to manage and govern the API spefication.
* A shareable link is available to the Mobile OpenAPI specification to be used by other teams and systems.

=== Cleanup
You can now close all API Designer and Service Registry browser tabs  (\^‿^)

{empty} +

== Configure 3scale API Management to secure and manage Mobile Gateway API

The Mobile API has now been designed by API Designer, and is governed by Red Hat Service Registry. 

Let us fast forward a bit in time, and the backend developers team has built the Mobile Gateway server-side code.  The *Mobile Gateway* has been built using Quarkus and acts as an API gateway for all of the Mobile app calls to Globex services. The source code can be found here https://github.com/rh-cloud-architecture-workshop/globex-mobile-gateway[globex-mobile-gateway^]. This Gateway service has been pre-deployed under the `module-apim-{user_name}` namespace on OpenShift. 


In this section you will manage and secure the Mobile Gateway API endpoints so that the Mobile App can access them securely. To create these API endpoints, and secure and managed them, we will need configure them on 3scale API management. 

=== Section Goals 

* setup Red Hat SSO provide single sign-on (SSO) capabilities to Mobile App 
* setup Red Hat SSO to secure Mobile Gateway API endpoints using OpenID Connect
* manage Mobile Gateway APIs with Red Hat 3scale API Management
* access Red Hat 3scale API Management's Developer Portal as a Mobile Developer to sign up for access of API

=== Red Hat 3scale - A quick intro
To manage and secure the APIs, you will be using Red Hat 3scale API management. 

* 3scale makes it easy to manage, share, secure, distribute, control, and monetize APIs. 
* 3scale integrates with Red Hat SSO for authenticating the API requests using the OpenID Connect specification. 
* When a external developer (in this case Mobile developer) signs up for an API, they will be provided with a client-id and client-secret which will need to be used to access the APIs securely. 
* 3scale syncronizes the client (application) credentials between 3scale and the Red Hat Single Sign-On server using a component know an *Zync*

In the next step you will setup Red Hat SSO so that 3scale will be able to synch the client credentials with SSO.

=== Red Hat SSO

In order to setup OpenID Connect as discussed in the previous section, you will now create a *client id* especially for *Client Credentials Management*

* Click here to launch {sso_tenant_console}[Red Hat SSO^, window="sso"] and login using username and password ({user_name}/{user_password}).
* Click on *Client* from the left-hand navigation. And, then click on the *Create* button on the right side as shown below

+
.Red Hat SSO: Clients listing
image::images/apim/client-add.png[]

* In the *Add Client* wizard, enter the following details

[width=60%]
|====
| Name | Value

|Client Id | `client-manager`
|Client Protocol (dropdown) | `openid-connect`
|====

.Red Hat SSO: Add Client wizard
image::images/apim/client-manager.png[]


* Click on *Save* button. You will be shown the *Settings* page of `client-manager` client.
+
.Red Hat SSO: View *client-manager* Settings
image::images/apim/new-client-save.png[]

* Configure this `client-manager` as follows so that 3scale can syncronize with Red Hat SSO
** Change *Access Type* to `Confidential`
** Once the Access Types is Confidential you will see a new toggle button *Service Accounts Enabled*
** Keep *Service Accounts Enabled* as ON, and turn all other Grants and Flow OFF to match the following screenshot.
+
This configuration allows only Services based access using Service Accounts, and will be used by 3scale API Management sytem in the next steps, when mobile users sign up for access. Service accounts provide a flexible way to control API access without sharing a regular user's credentials.
+
.Red Hat SSO: Confgure client-manager
image::images/apim/client-manager-setting.png[]

* Click on *Save* button at the bottom of the page. You will be notified that the changes are saved successfully. +
.Red Hat SSO: Save client-manager settings
image::images/apim/client-manager-save.png[]

* Now you will need to setup *Client Roles* for this client id, so that it can manage client (create, amend and delete) on behalf of 3scale API Management
** Click on the *Service Account Roles* tab from the top tab navigation.
** From the *Client Roles* dropdown, choose `realm-management`
+
.Red Hat SSO: Setup Service Account Roles for *client-manager* in Service Account Roles tab
image::images/apim/sso-service-acc-tab.png[]
* From the *Available Roles* multichoice field, choose `manage-clients`, and click on *Add selected >>* button
** The mappings will get auto-saved.
+
.Red Hat SSO: Add manage-clients roles
image::images/apim/client-realm-management.png[]

* You can view the credentials of this client-id by choosed the *Credentials* tab. You will need this when setting up the 3scale products +

.Red Hat SSO: Client Credentials of client-manager
image::images/apim/client-manager-credentials.png[]


=== Create Mobile Gateway Backend, Product and ActiveDoc on 3scale

To integrate and manage your API in 3scale you need to create Products and Backend

* *Backends* are Internal APIs which are then bundled in a product. 
** contains at least the URL of the API
** can optionally be configured with mapping rules, methods and metrics to facilitate reusability.
* *Products* are the Customer-facing APIs. 
** define the application plans, and configure APIcast
** create API documentation by attaching the Mobile OpenAPI as an *3scale ActiveDoc*

3scale offers a framework to create interactive documentation for your API through ActiveDocs. With Swagger 2.0 (based on the Swagger Spec) this provides a functional, attractive documentation for the API, which will help  developers to explore, to test and integrate with the APIs.


In this workshop you will be using the *3scale Operator* that creates and maintains 3scale on OpenShift with custom resource definitions (CRDs). A CRD file allows you to define your own object kinds (Backend, API, ActiveDoc etc) and lets the API Server handle the entire lifecycle of the objects.



==== Create 3scale Backend for MobileGateway service
You will the Service URL of Mobile Gateway deployment running on OpenShift

[NOTE]
====
In OpenShift, a Kubernetes Service serves as an internal load balancer and identifies pods which in turn has the applications. If the application needs to be accessed from outside of OpenShift, you will need OpenShift routes. +
In this workshop, since both 3scale and the Mobile Gateway run on OpenShift, 3scale will proxy requests to the backend using Services. This also means  the backend cannot be accessed directly from outside OpenShift.
====

* The service endpoint of the `Mobile Gateway API` deployment is this 
+
[source,bash,role=copy,subs="attributes"]
.Service hostname of the Mobile Gateway API
----
http://globex-mobile-gateway.globex-apim-{user_name}.svc.cluster.local:8080
----

* If you would like to understand how to fetch from the OpenShift console, expand the following collapsible section
+
.[.underline]#*Click to learn how to fetch Service URL from  OpenShift console*#
[%collapsible]
====
* Navigate to the `globex-apim-{user_name}` namespace on the OpenShift console by clicking here {openshift_cluster_console}/topology/ns/globex-apim-{user_name}[APIM module on OpenShift^] and login with ({user_name}/{user_password}).
* In the *Find by name* filter enter the value `mobile-gateway`. The `globex-mobile-gateway` deployment is highlighted. Clicking on this deployment opens the context menu for this deployment
+
.Locate globex-mobile-gateway deployment
image::images/apim/globex-mobile-gateway-deplpyment.png[]
* Under *Services* section you can see the name of the services assocated with this deployment. Click on the `globex-mobile-gateway` link and you will be taken to the Services page. 
* Under *Service routing -> Hostname*, you can find the service's hostname. Make a note of this URL and you will need this to create the Backend on 3scale.
+
.Mobile Gateway Service in OpenShift
image::images/apim/mobile-gateway-services.png[]

====

* Navigate to the *Dev Spaces browser tab* you have launched at the beginning of this module
** If this broswer tab is not open, click on {devspaces_dashboard}/dashboard/#/ide/devspaces-{user_name}/cloud-architecture-workshop[Devspaces IDE^, window="devspaces"] and login with ({user_name}/{user_password}).
* Navigate to the folder `workshop -> module-apim -> mobile -> gateway` and open the `mobile-gateway-backend.yaml` file.
* In the file `mobile-gateway-backend.yaml`, update the `<replace-me>` placeholder with the Service endpoint of the Globex Mobile gateway service appended with the port as `:8080`. +
+
[source,bash,role=copy,subs="attributes"]
.Service hostname of the Mobile Gateway API
----
http://globex-mobile-gateway.globex-apim-{user_name}.svc.cluster.local:8080
----

.Update mobile-gateway-backend.yaml with Service endpoint of Globex Mobile gateway
image::images/apim/mobile-backend-yaml.png[]

* The *privateBaseURL* in the *mobile-gateway-backend.yaml* file should read like this:
+
[source,bash,role=copy,subs="attributes"]
----
privateBaseURL: "http://globex-mobile-gateway.globex-apim-{user_name}.svc.cluster.local:8080"
----
* From the Terminal of Devspaces that should be open already
* Run the following command `oc whoami` to check if you are still logged in as *{user_name}* and `oc project` to see if you are in the project `globex-apim-{user_name}`
+
[source,bash , subs="attributes"]
.Check logged-in username and project
----
$ oc whoami
{user_name}
$ oc project
Using project "globex-apim-{user_name}" on server...
----
* Run the following command which will create a Mobile Gateway Backend in 3scale.
+
[source,bash,role=copy, subs="attributes"]
.create Mobile Gateway Backend in 3scale
----
oc apply -f /projects/workshop-devspaces/workshop/module-apim/mobile/gateway/mobile-gateway-backend.yaml 
----

* You should see the output as 
+
.Output of Mobile Gateway Backend creation
----
backend.capabilities.3scale.net/globex-mobile-gateway-backend configured
----

==== Create 3scale Product for MobileGateway API

* In Devspaces in the same folder as the previous teps `workshop -> module-apim -> mobile -> gateway`, open the file `mobile-gateway-product.yaml`. This file creates a 3scale product, and also attached to it the Backend we created in the previous step.
* Update the following 2 values as directed below.
+
image::images/apim/mobile-gateway-product.png[] 

** *<client-credentials>* : Value of Client Credentials of the *client-manager* client you created in Red Hat SSO in the previous step
+
[NOTE]
====
If you don't have this value, click on {sso_tenant_console}/#/realms/globex-{user_name}/clients[SSO Clients List]. Login if needed with *({user_name}/{user_password})*. Click on the the Client ID *client-manager*. You can copy the credentials from the *Credentials tab*
====
+
image::images/apim/client-manager-credentials.png[]
** *<issuer-endpoint>* : Value as below

[source,bash,role=copy, subs="attributes"]
----
sso.{openshift_subdomain}/auth/realms/globex-{user_name}
----
[NOTE]
====
This URL is from Red Hat SSO's *Issuer endpoint* from https://sso.{openshift_subdomain}/auth/realms/globex-{user_name}/.well-known/openid-configuration[well known configurations endpoint^]. 

.Red Hat SSO Issuer URL

image::images/apim/sso-issuer-endpoint.png[] 

====
* The `mobile-gateway-product.yaml` file should looks like this now +
+
.mobile-gateway-product.yaml updated with the correct values
image::images/apim/mobile-product-gateway-product-issuerendpoint.png[]
* Execute the following command in the Terminal to create this Product for Mobile Gateway 
+
[source,bash,role=copy, subs="attributes"]
.Execute command in Terminal to create Mobile Gateway on 3scale
----
oc apply -f /projects/workshop-devspaces/workshop/module-apim/mobile/gateway/mobile-gateway-product.yaml 
----

* You will the see the following output confirming creation of 3scale Product for Mobile Gateway: 
+
.Output
----
product.capabilities.3scale.net/globex-partner-gateway-product created
----

==== Create Active Doc for Mobile Gateway

* In Devspaces, navigate to the folder `workshop -> module-apim -> mobile -> activedoc`, open the file `create-mobile-activedoc.yaml`
+
image::images/apim/mobile-activedoc-yaml.png[width=70%]
* Replace the `<replace-me>` placeholder with the Service Registry OpenAPI endpoint. This is the same OpenAPI spec that you setup on Service Registry.
+
[source,bash,role=copy,subs="attributes"]
.Copy Service Registry OPENAPI endpoint
----
{service_registry_url}/apis/registry/v2/groups/globex/artifacts/mobileapi
----
+
.ActiveDoc updated with OpenAPI Service Registry endpoint 

image::images/apim/mobile-activedoc-create-file.png[]

* Create this Active Doc by running the following command in the Devspaces Terminal
+
[source,bash,role=copy,subs="attributes"]
.Create Activedoc command
----
oc apply -f /projects/workshop-devspaces/workshop/module-apim/mobile/activedoc/create-mobile-activedoc.yaml 
----
+
.Output
----
activedoc.capabilities.3scale.net/mobile-gateway-activedoc created
----

=== Setup Mobile users
The Mobile developers of Globex will need access to the Developer Portal to signup for the APIs exposed to them. Typically they would access the developer portal and signup for an account which may as needed go through an approval process

For the purpose of this workshop let us run a few commands to setup these users as defined in the file `mobile-dev-setup.yaml`.

* In the *Devspaces Terminal* run the following command
+
[source,bash,role=copy,subs="attributes"]
.Create users command
----
oc apply -f /projects/workshop-devspaces/workshop/module-apim/mobile/users/mobile-dev-setup.yaml
----

* You will see the output as 
+
.Output of user creation
----
secret/mobileuser.secret created
developeraccount.capabilities.3scale.net/mobile-developeraccount created
developeruser.capabilities.3scale.net/admin.mobile created
developeruser.capabilities.3scale.net/dev.mobile created
----
* You can view these users on the 3scale admin portal as well at {3scale_tenant}/buyers/accounts[3scale admin portal, window="3scale"]

=== View the newly created Backend, Product,  ActiveDoc and Users

=== View via 3scale Operator page in OpenShift console
* You can now see that the Backend, Product, ActiveDoc and Users from the 3scale OpenShift operators on {openshift_cluster_console}/k8s/ns/globex-apim-user2/clusterserviceversions[Installed Operators^, window=_console]
** Navigate to `Red Hat Integration - 3scale -> All Instances` and click on `Current namespace only`. You will see that the Product and Backend have been created.
+
.View Product, Backend, ActiveDoc and Users 
image::images/apim/apim-mobile-back-prod-active-users.png[] 

=== View on 3scale admin console

* Navigate to {3scale_tenant}[3scale admin portal, window="3scale"] and login using your username and password ({user_name}/{user_password}).
+
.Launch 3scale 
image::images/apim/apim-mobile-3scale-login.png[]
* You will notice that the Mobile Product and Backend have been created.
* Click on *globex-mobile-gateway-product* under *APIs -> Products* section. 
* You are presented with Product overview page for the Mobile API Product you created. Note the following elements
** Published Application Plans 
+
[NOTE]
====
Application Plans define the different sets of access rights you might want to allow for consumers of your API. These can determine anything from rate limits, which methods or resources are accessible and which features are enabled
====

** Backend that has been attached to the Mobile Gateway Product
+
.Mobile Gateway Product: Overview
image::images/apim/mobile-product-overview.png[]

* Navigate to *Integration -> Settings* page from the Product overview page. You will notice that the Product has been setup with 
** OpenID Connect as Authentication mechanism
**  *client_manager* client details that you had created in the previous steps.
** OIDC Authorization Flow includes *Implicit Flow* because we would be authenticating the users SSO as well access to the backend services
+
.Mobile Gateway Product: Settings
image::images/apim/mobile-product-openid-settings.png[]

* The ActiveDoc is visible from 3scale portal as well under Products. <tbc - do we need this? refine>
+
.Mobile Gateway Product: ActiveDoc
image::images/apim/apim_3scale_activedoc.png[]
* Navigate to `Integration -> Configuration` and click on the *Promote to v.x Staging APICast* and then *Promote to v.x Production APICast* to promote all the config changes
//TBC find ways to overcome this step//
** APIcast is an NGINX based API gateway used to integrate internal and external API services with the 3scale.  APIcast acan be hosted or self-managed. Im this workshop we use the default `self-managed` option.
+
.Promote Staging and Production APICast
image::images/apim/mobile-promote-apicast.png[]


=== Setup Globex Dev Portal
A good developer portal is a must have to assure adoption of your API. In this section we will setup the Dev Portal so that it ready to be used by Mobile Developers.

* Navigate to  `3scale's Audience ->Developer Portal -> Settings`  by clicking on {3scale_tenant}/site/dns[Settings -> Domains & Access section, window="3scale"]
* The *Developer Portal Access Code* hides the site from the world till you are ready.
* Remove the value in the textfield below the label `Developer Portal Access Code` as show below. Click on `Update Account`
+
.Remove Developer Portal Access Code
image::images/apim/apim_domain_access.png[]

* This opens up the Developer Portal to public access without a accesscode

* The next step is to allow a Developer to access *Multiple APIs (Services)* and signup for *Multiple Applications*
* Navigate to  {3scale_tenant}/p/admin/cms/switches[Developer Portal -> Feature Visibility section, window="3scale"]
* Click on the *Show* button against the features *Multiple Services* and *Multiple Applications* so that it appears as show 
+
.Feature Visibility section
image::images/apim/apim_feature_visbility_init.png[]
* After update this page should be seen as per the screenshot below. 
+
.Feature Visibility settings altered
image::images/apim/apim_feature_visibility.png[]

* The Globex Developer Portal is fully setup now for Mobile dveelopers to signup


=== Sign up as a Mobile Developer
In this section you will login as a Mobile Developer (as the user you created in the previous section), and signup for API access

* Launch the Globex Developer Portal by clicking on {globex_developer_portal}[Developer Portal^]
+
.Developer Portal
image::images/apim/3scale_dev_portal.png[]

* Click on the *SIGN IN* link found on top-right. 
* Sign in as one of the user you created in the previous section with
** username: `dev.mobile`
** password: `openshift`
+
.Developer Portal
image::images/apim/3scale_dev_portal_signin.png[width=70%]
* Navigate to Applications Listing by choosing the *APPLICATIONS* menu on the top of the page.

+
.Developer Portal Landing Page
image::images/apim/3scale_dev_portal_loggedin.png[width=80%]
* In the  Applications page You are invited to *Create Application*. Click on the *Create new application* button seen against `globex-mobile-gateway-product`
+
.Developer Portal: Create new application
image::images/apim/3scale_dev_portal_applications.png[width=70%]
* Click on *Subscribe to globex-mobile-gateway-product* link
+
.Subscribe to globex-mobile-gateway-product
image::images/apim/apim-devportal-mobile-subscribe.png[]
* You are sucessfully subscribed to the service
+
.Sucessfully subscribed to the service
image::images/apim/apim-devportal-mobile-subscribe-success.png[width=70%]

* Navigate back to the  *APPLICATIONS tab* found on the top menu and  click *globex-mobile-gateway-product's* > *Create new application* link +
+
.Developer Portal: Create new application (again)
image::images/apim/3scale_dev_portal_applications.png[width=70%]


* Give the plan a *Name* and a *Description* and click on *Create Application* 
+
.Developer Portal: New application 
image::images/apim/apim-devportal-mobile-create-new-app-2.png[width=70%]
* An application is created successfully. Make a note of the *Client ID* and *Client Secret*. You will be using this in the Mobile App setup.
* Enter the value asterisk (*) in the **REDIRECT URL** field and click on **Submit** button. This is to setup the right Redirect URL for OAuth using Red Hat SSO
+
.Update REDIRECT URL in the Application creates successfully for Mobile User
image::images/apim/apim-devportal-mobile-app-success.png[width=90%]
* Copy the *Client ID* from this page which will be used to setup Mobile App
* In Devspaces open the file: *Devspaces -> workshop -> module-apim -> mobile -> mobile-env-patch.sh*
** Substitue `<replace-me>` found against the  the `API_CLIENT_ID` variable with the *Client ID* in the previous step
+
.Update client_id into mobile-env-patch file
image::images/apim/mobile-clientid-env-patch.png[width=70%]
* Back in the Developer Portal Click on *DOCUMENTAION* navigation on the top of the page. 
* The *Documentation* page displays all the available APIs including the default API as well as *globex-mobile-gateway-product*
+
.Dev Portal: Documentation Page
image::images/apim/dev_portal_mobile_doc.png[]
** Copy the URL displayed under "Service Endpoint" in *globex-mobile-gateway-product* box
** In Devspaces navigate back to the open file: *Devspaces -> workshop -> module-apim -> module -> mobile-env-patch.sh*
** Substitue `<replace-me>` found against the  the `GLOBEX_MOBILE_GATEWAY` variable with the *Service Endpoint* in the previous step
+
.Update GLOBEX_MOBILE_GATEWAY into mobile-env-patch file
image::images/apim/mobile-mobgateway-env-patch.png[width=60%]
* In the same file update the *<replace-me>* tags for the  *SSO_AUTHORITY* and *SSO_REDIRECT_LOGOUT_URI* fields with the following variables
+
[cols="30%,60%"]

|===
|Field | Value

| SSO_AUTHORITY | \https://sso.{openshift_subdomain}/auth/realms/globex-{user_name}
| SSO_REDIRECT_LOGOUT_URI | \https://globex-mobile-globex-apim-user2.{openshift_subdomain}/home
|===
+
.Update SSO details into mobile-env-patch file
image::images/apim/mobile-sso-env-patch.png[]
* Finally the `mobile-env-patch.sh file should look like this. Save the file by `Ctrl+S`
+
.Fully updated mobile-env-patch file
image::images/apim/mobile-full-env-patch.png[]
* Execute this script in the Terminal by running the following command in Dev spaces' Terminal
+
[source,bash,role=copy,subs="attributes"]
.Run mobile-env-patch.sh script
----
sh /projects/workshop-devspaces/workshop/module-apim/mobile/mobile-env-patch.sh
----
+
[source,subs="attributes"]
.Output of running mobile-env-patch.sh script
----
deployment.apps/globex-mobile updated
----
* The Mobile App Deployment is patched with the necessary variables. You can view this navigating to {openshift_cluster_console}/k8s/ns/globex-apim-{user_name}/deployments/globex-mobile/environment[globex-mobile deployment, window="console"]
+
.globex-mobile deployment on OpenShift
image::images/apim/apim_globex_mobile_deployment.png[]

==== Update  Red Hat SSO's Web Origin to match Mobile App
There is one last step that you need to do before trying out the Mobile App. You need to update the *Web Origin*

* Navigate to click on {sso_tenant_console}/#/realms/globex-{user_name}/clients[SSO Clients List]. Click on the new Client ID that was created when you signed up for Mobile Gateway Application
* Close to the bottom of this page, you would see *Web Origins* field. 
* Update this field with the following value and click on *Save*
+
[source,bash,role=copy, subs="attributes"]
.Value for Web Origin
----
https://globex-mobile-globex-apim-{user_name}.{openshift_subdomain}
----
+
.Update Web Origin in Red Hat SSO's new Client ID, and click on Save.
image::images/apim/apim_mobile_sso_weborigin.png[]

=== Section Outcome
* 3scale Backend, Product, ActiveDocs and Users were created
* Developer Portal was setup for public access without Access Code
* Signed for an Application as a Mobile Developer
* Patched Red Hat SSO Web Origin so that the calls from Globex Mobile App will not cause errors

== Test Mobile Application 

In the previous section, you signed up for access as a Mobile Developer and gained credentials to access the Globex Mobile Gateway API. In this section you will complete Mobile App configuration and test this out

[NOTE]
====
As part of this workshop, you will use a mobile-friendly Angular App and not a mobile-native app. So no mobile app installation is necessary. This Mobile App is work in progress and at present shows only categoeies and products within each category.
====

The Mobile Application can be access via this QR Code as well as via browser

* Scan the following QR Code with your mobile phone
+
.Scan to view Mobile App
image::https://chart.googleapis.com/chart?chs=300x300&amp;cht=qr&amp;chl=https://globex-mobile-globex-apim-{user_name}.{openshift_subdomain}[Globex Mobile,200,300]
 
* Alternatively, launch https://globex-mobile-globex-apim-{user_name}.{openshift_subdomain}[Globex Mobile^]


* Login using (asilva/openshift)
+
.User is logged in
image::images/apim/apim-mobile-loggedin.png[width=40%]
* After logging in, click on "View the categories" button. You will view on a list of Categories available
+
.Categories view
image::images/apim/mobile-categories.png[width=40%]
* Click on the 'Clothing' category to view the Product Listing.


=== Section Outcome
* As part of this Section you tried out the Mobile App. 

*Under the hood:*

* The user *asilva* you logged into the Mobile App as, is authenticated using Red Hat SSO.
* Once the user logs in, a token is generated by Red Hat SSO using the Client ID, SSO Authority details that you passed to the Mobile App to setup the configuration
* This token is authenticated by  3scale to ensure the Client ID indeed has access to that particular API
* The token is also passed onto the backend service running on OpenShift, which checks for validity of the token. 
* The https://github.com/rh-cloud-architecture-workshop/globex-mobile-gateway/blob/main/src/main/java/org/globex/gateway/mobile/rest/MobileCatalogResource.java[REST endpoints^, window="code-samples"] is supplied with the SSO URL information as part of the https://github.com/rh-cloud-architecture-workshop/globex-mobile-gateway/blob/main/src/main/resources/application.properties[application.properties, window="code-samples"]
* The endpoints are protected with @Authenticated which in this case looks for a valid token being present.
+
.REST endpoint is annotated with @Authenticated
image::images/apim/mobile_rest_java.png[]

With that we wrap up Design, Govern, Manage, Secure Globe Mobile Gateway APIs  for access from the Mobile Application securely.

Coming up next: We will setup the Globex Partner APIs for access by external Partner portals.


{empty} +

== Setup Partner Gateway and Partner Web App

Before we start this section,  close all the browser tabs except for this Instructions tab and Devspaces tab. This will help you navigate this section better.

Since we've gone through the  Design and Governance sections of the Mobile API, in this section we will skip the design section. We'll also keep discussions to essentials only :")



=== Publish Partner API to Service Registry

* If you don't have a browser tab open on to Dev Spaces, click on {devspaces_dashboard}/dashboard/#/ide/devspaces-{user_name}/cloud-architecture-workshop[Devspaces IDE^, window="devspaces"]. If needed login with your username and password ({user_name}/{user_password}).
* In Devspaces, navigate to the folder `workshop -> module-apim -> partner -> activedoc`, and open the file `partner-activedoc-draft.json`
* Scroll to the bottom of the page where you can see the *securitySchemes* section
+
.Partner OpenAPI Securty Schemes section
image::images/apim/partner-api-securty-scheme.png[] 
* Substitue *<replace-me>* with the Red Hat SSO's OpenID Provider Configuration shown below
+
[source,bash,role=copy, subs="attributes"]
----
https://sso.{openshift_subdomain}/auth/realms/globex-{user_name}/.well-known/openid-configuration 
----
+
.Updated Security Scheme
image::images/apim/partner-sec-scheme-updated.png[]
* Execute the following command from the Dev Spaces' Terminal
+
[source,bash,role=copy, subs="attributes"]
.POST OpenAPI to Service Registry
----
curl -X POST -H "Content-type: application/json; artifactType=OPENAPI" -H "X-Registry-ArtifactId: partnerapi" -d @/projects/workshop-devspaces/workshop/module-apim/partners/activedoc/partner-activedoc-draft.json {service_registry_url}/apis/registry/v2/groups/globex/artifacts
----
* The following JSON is returned back by Service Registry confirming creation
+
.Output response from Service Registry
----
{"name":"Globex Partners API Gateway","description":"Globex APIs made accessible to global partners to view Globex' catalog and products","createdBy":"","createdOn":"2023-05-05T22:51:01+0000","modifiedBy":"","modifiedOn":"2023-05-05T22:51:01+0000","id":"partnerapi","version":"1","type":"OPENAPI","globalId":2,"state":"ENABLED","groupId":"globex","contentId":2,"references":[]}workshop-devspaces (main)
----
* You can view the newly imported OpenAPI specification {service_registry_url}/ui/artifacts/globex/partnerapi/versions/latest[here^, window="serviceregistry"]

=== Create Backend, Products, ActiveDoc and Users for Partner Gateway

==== Create Backend
* In Devspaces , under the folder `workshop -> module-apim -> partners -> gateway`, open the file `partner-gateway-backend.yaml`
* Substitue  *"<replace-me>"* with the Service endpoint of the Globex Partner gateway service appended with the port as `:8080`. This URL is given below 
+
[source,bash,role=copy,subs="attributes"]
.Service hostname of the Mobile Gateway API
----
http://globex-partner-gateway.globex-apim-{user_name}.svc.cluster.local:8080
----
* After substitution the *partner-gateway-backend.yaml* file should looks like 
.partner-gateway-backend file
image::images/apim/partner-gateway-backend.png[]
* Run the following command which will create a Partner Gateway Backend in 3scale.
+
[source,bash,role=copy, subs="attributes"]
.create Partner Gateway Backend in 3scale
----
oc apply -f /projects/workshop-devspaces/workshop/module-apim/partners/gateway/partner-gateway-backend.yaml 
----
.Output
----
backend.capabilities.3scale.net/globex-partner-gateway-backend created
----

==== Create  Products
* In Devspaces , under the folder `workshop -> module-apim -> partners -> gateway`, open the file `partner-gateway-product.yaml`
.partner-gateway-product.yaml file
image::images/apim/partner-gateway-product.png[]
* Fetch  *<client-credentials>* value as described below
**  Open the {sso_tenant_console}/#/realms/globex-{user_name}/clients[SSO Clients List^, window="sso"]. Login if needed with *({user_name}/{user_password})*. 
** Click on the the Client ID *client-manager*. You can copy the credentials from the *Credentials tab*
+
.client_manager credentials
image::images/apim/client-manager-credentials.png[]

** Substitue *<client-credentials>*  with this Credentials.
* Substitue *<issuerEndpoint>*  with the following value
+
[source,bash,role=copy, subs="attributes"]
----
sso.{openshift_subdomain}/auth/realms/globex-{user_name}
----

* The file `partner-gateway-product.yaml` looks like this now

+
image::images/apim/product-gateway-product-issuerendpoint.png[]
* Run the following command in the Devspaces Terminal to create the product
+
[source,bash,role=copy, subs="attributes"]
.Create partner product
----
oc apply -f /projects/workshop-devspaces/workshop/module-apim/partners/gateway/partner-gateway-product.yaml 
----

.Output
----
product.capabilities.3scale.net/globex-partner-gateway-product created
----

=== Create Active Doc for Partner Gateway
* In Devspaces, navigate to the folder `workshop -> module-apim -> partners -> activedoc`, open the file `create-partner-activedoc.yaml`
+
image::images/apim/mobile-activedoc-yaml.png[width=70%]
* Replace the `<replace-me>` placeholder with the Service Registry OpenAPI endpoint for Partner API show below
+
[source,bash,role=copy,subs="attributes"]
.Service Registry Mobile OpenAPI endpoint
----
{service_registry_url}/apis/registry/v2/groups/globex/artifacts/partnerapi
----


* Create this Active Doc by running the following command in the Devspaces Terminal
+
[source,bash,role=copy,subs="attributes"]
.Create Activedoc command
----
oc apply -f /projects/workshop-devspaces/workshop/module-apim/partners/activedoc/create-partner-activedoc.yaml 
----
+
.Output
----
activedoc.capabilities.3scale.net/partner-gateway-activedoc created
----


=== Setup Partner users
* Create this Active Doc by running the following command in the Devspaces Terminal
+
[source,bash,role=copy,subs="attributes"]
.Create Activedoc command
----
oc apply -f /projects/workshop-devspaces/workshop/module-apim/partners/users/partner-dev-setup.yaml
----
+
.Output
----
secret/partner.secret created
developeraccount.capabilities.3scale.net/partner-developeraccount created
developeruser.capabilities.3scale.net/admin.partner created
developeruser.capabilities.3scale.net/user.partner created
----

=== Configurations on 3scale admin console

* Navigate to {3scale_tenant}[3scale admin portal, window="3scale"] and login using your username and password ({user_name}/{user_password}).
+
.Launch 3scale 
image::images/apim/apim-partner-3scale-login.png[]
* You will notice that the Partner Product and Backend have been created.
* Click on *globex-partner-gateway-product* under *APIs -> Products* section. 
* You are presented with Product overview page for the Partner API Product you created. 
* Navigate to `Integration -> Configuration` and click on the *Promote to v.x Staging APICast* and then *Promote to v.x Production APICast* to promote all the config changes
//TBC find ways to overcome this step//
+
.Promote Staging and Production APICast
image::images/apim/partner-promote-apicast.png[]

=== Signup for an application as a Partner
* Navigate to the Developer Portal {globex_developer_portal}[Globex Developer Portal^]
* If you are already signed in, clicking on the Exit  option on top-right of the page.
+
.Logout
image::images/apim/logout.png[]
* Click on *SIGN IN* on top right of the page and login using username and password as (user.partner/openshift)
* Navigate to Applications Listing by choosing the *APPLICATIONS* menu on the top of the page.

+
.Developer Portal Landing Page
image::images/apim/3scale_dev_portal_loggedin.png[width=80%]
* In the  Applications page You are invited to *Create Application*. Click on the *Create new application* button seen against `globex-partner-gateway-product`
+
.Developer Portal: Create new application
image::images/apim/partner_3scale_dev_portal_applications.png[width=70%]
* Click on *Subscribe to globex-partner-gateway-product* link
+
.Subscribe to globex-mobile-gateway-product
image::images/apim/apim-devportal-partner-subscribe.png[]
* You are sucessfully subscribed to the service
+
.Sucessfully subscribed to the service
image::images/apim/apim-devportal-partner-subscribe-success.png[width=70%]

* Navigate back to the *APPLICATIONS tab* via on the top menu and  click *globex-partner-gateway-product's* > *Create new application* link +
+
.Developer Portal: Create new application (again)
image::images/apim/3scale_dev_portal_applications_partner.png[width=70%]


* In the NEW APPLICATION page, give the plan a *Name* and a *Description* and click on *Create Application* 
+
.Developer Portal: New application 
image::images/apim/apim-devportal-partner-create-new-app-2.png[width=70%]
* An application is created successfully. Make a note of the *Client ID* and *Client Secret*. You will be using this in the Partner Web Portal setup.
* Enter the value asterisk (*) in the **REDIRECT URL** field and click on **Submit** button. This is to setup the right Redirect URL for OAuth using Red Hat SSO
+
.Update REDIRECT URL in the Application creates successfully for Partner User
image::images/apim/apim-devportal-partner-app-success.png[width=70%]

=== Setup Partner Web Portal
* In the previous section, you signed up for access as a Partner Developer and gained credentials to access the APIs Globex exposes.
* To update the Partner Web application you need 4 values
. Client ID
. Client Secret
. Token URL
. Globex API Endpoint
* These values are part of `globex-partner-web` Deployment and are highlighted in the screenshot below

image::images/apim/partner-web-deployment-env.png[]


* To update *Client ID* and  *Client Secret*, *secret.yaml* Secret needs to be updated.
*  In the Dev workspace, open the file `/projects/workshop-devspaces/workshop/module-apim/partners/partner-web/secret.yaml` 
+
.secret.yaml
image::images/apim/partner_secret_yaml.png[width=60%]


* Update the Client Id, Secret from the previous step on 3scale Developer Portal
* Update *Token URL* with the following value
+
[source,bash,role=copy,subs="attributes"]
.update TokenURL
----
https://sso.{openshift_subdomain}/auth/realms/globex-{user_name}/protocol/openid-connect/token
----

* In the *Devspaces Terminal* apply changes made to the *secret.yaml* by running the following command
+
[source,bash,role=copy,subs="attributes"]
.Apply secret.yaml changes
----
oc apply -f /projects/workshop-devspaces/workshop/module-apim/partners/partner-web/secret.yaml 
----
+
.Output
----
secret/globex-partner-web configured
----
* The final setp is to patch the Partner Web portal with the *Partner Gateway API's endpoint*.
* Execute this script in the Devspaces Terminal

+
[source,bash,role=copy,subs="attributes"]
.Run script to update GLOBEX_PARTNER_GATEWAY
----
oc set env deployments/globex-partner-web --overwrite GLOBEX_PARTNER_GATEWAY=https://globex-partner-gateway-product-3scale-{user_name}-apicast-production.{openshift_subdomain}
----
+
[source,subs="attributes"]
.Output 
----
deployment.apps/globex-partner-web updated
----


== Test Partner Web Application 

In the previous section, you signed up for access as a Partner Developer and gained credentials to access the Globex PArtner Gateway API. You also setup the necessary confgurations for the Partner Web Application.


* Launch the https://globex-partner-web-globex-apim-{user_name}.{openshift_subdomain}[Globex Partner Web^]
+
.Partner Web Portal
image::images/apim/partner_web_portal.png[]
* Login using (partner/openshift). The partner users are not managed using Red Hat SSO. 
+
.User is logged in
image::images/apim/apim-partner-loggedin.png[]
* After logging in, the entire product list is show in a paginated format.



=== Section Outcome
* As part of this Section you tried out the Mobile App. 

*Under the hood:*

* The user *partner* you logged into the Partner App as, is not authenticated using Red Hat SSO. In fact it is not authenticated at all. 
** This because how partners handle user authentication is not handles by Globex at all
* In this scenario we use Client Credentials authentication, because the backend NodeJS server authenticates itself with Client ID and Credentials obtaines by the Partner Developer while sining up for an Application via 3scale Developer Portal
* The token geenrated by NodeJS is then exchanged with 3scale to ensure the Client ID indeed has access to that particular API

//TBC more discusssion on design decisions//

With that we wrap up the Contract First API workshop module.